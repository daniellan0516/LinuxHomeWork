# copyright by Daniel Lan @ 20220707
SUPER_USER=rockylinux
USER=vfepadm
SERVER_IP=192.168.220.137
PROJECT_ROOT=$(dirname $(realpath $0))
REMOVE_USER=false

# 偵測本地 IP
if [ "$(uname -a | grep -i linux)" ];
then
  export CURRENT_IP=$(ifconfig | grep 192.168 | awk -F' ' '{print $2}')
else
  export CURRENT_IP=$(ipconfig /all | grep 192.168.220 | awk -F' ' '{print $14}' | awk -F'(' '{print $1}')
fi

# 更新SSH金鑰
if [ -f "$PROJECT_ROOT/.ssh/authorized_keys" ]; then
  mkdir -p $PROJECT_ROOT/.ssh
  chmod 700 $PROJECT_ROOT/.ssh
  dirid=$(md5sum $PROJECT_ROOT/.ssh/authorized_keys | awk -F" " '{print $1}')
  curid=$(md5sum ~/.ssh/id_rsa.pub | awk -F" " '{print $1}')
  if [ $dirid != $curid ];
  then
    echo "更新私鑰"
    cp ~/.ssh/id_rsa.pub $PROJECT_ROOT/.ssh/authorized_keys
  fi
else
  echo "新增私鑰"
  cp ~/.ssh/id_rsa.pub $PROJECT_ROOT/.ssh/authorized_keys
fi && chmod 600 $PROJECT_ROOT/.ssh/authorized_keys

# 更新VM
updateVM() {
  cd $PROJECT_ROOT
  if [ "$1" = "-h" ];
  then
    echo "1. 可以設定.env檔案裡的環境變數(SUPER_USER, USER, SERVER_IP)，然後source .env"
    echo "2. 或是後面接user@host"
    return
  fi
  [ -f "$PROJECT_ROOT/package.tar.gz" ] && rm $PROJECT_ROOT/package.tar.gz 
  echo "打包資料上傳到伺服器......"
  tar -cf - * .ssh | gzip -c >  $PROJECT_ROOT/package.tar.gz
  cat $PROJECT_ROOT/package.tar.gz | ssh $SUPER_USER@$SERVER_IP 'gzip -dc - | tar x && ./UserAdd_Install.sh'

  [ $? -eq 255 ] && echo -e "\\033[31m等伺服器重開機\\033[0m" && sleep 1m
  ssh $USER@$SERVER_IP './CreateContainer.sh'
  sed -e "s/\$CURRENY_IP/$CURRENT_IP/" log_module/Backup_Del_Log.sh | ssh $USER@$SERVER_IP 'cat - > log_module/Backup_Del_Log.sh'
  [ -f "$PROJECT_ROOT/package.tar.gz" ] && rm $PROJECT_ROOT/package.tar.gz 
}

# 清除VM
clearVM() {
  if [ "$1" = "-h" ];
  then
    echo "1. 可以設定.env檔案裡的環境變數(SUPER_USER, USER, SERVER_IP)"
    echo "2. 或是後面接user@host"
    return
  fi
  ssh $USER@$SERVER_IP 'container_module/RemovePod.sh'
  [ "$REMOVE_USER" = "true" ] && \ 
  ssh $SUPER_USER@$SERVER_IP "sudo ./RemoveUser.sh $USER"
}
